{% extends "base.html" %}

{% block title %}All Reports | DMARCus Analyzer{% endblock %}

{% block content %}
<div class="container-fluid main-content">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">All DMARC Reports</h1>
            <small class="text-muted">Comprehensive view of all processed reports</small>
        </div>
        <div class="d-flex mt-3 mt-sm-0">
            <a href="/upload" class="btn btn-primary">
                <i class="bi bi-upload me-1"></i> Upload Report
            </a>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header bg-white">
            <h6 class="m-0 font-weight-bold text-primary">Report Summary</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="reportsTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Organization</th>
                            <th>Domain</th>
                            <th>Reports</th>
                            <th>Total Emails</th>
                            <th>Auth Pass Rate</th>
                            <th>Date Range</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for group in grouped_reports %}
                        <tr>
                            <td>{{ group.org }}</td>
                            <td>{{ group.domain }}</td>
                            <td>{{ group.total_reports }}</td>
                            <td>{{ group.total_records }}</td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: {{ group.pass_rate }}%" 
                                         aria-valuenow="{{ group.pass_rate }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        {{ group.pass_rate }}%
                                    </div>
                                </div>
                            </td>
                            <td>{{ group.date_range.start }} to {{ group.date_range.end }}</td>
                            <td>
                                <a href="{{ url_for('report_detail', org_name=group.org) }}" 
                                   class="btn btn-sm btn-primary">
                                    <i class="bi bi-eye"></i> View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script>
    
    $(document).ready(function() {
        $('#reportsTable').DataTable({
            responsive: true,
            order: [[2, 'desc']],
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search reports...",
            },
            dom: '<"top"<"row"<"col-md-6"l><"col-md-6"f>>>rt<"bottom"<"row"<"col-md-6"i><"col-md-6"p>>>',
            initComplete: function() {
                // Custom search input styling
                $('.dataTables_filter input').addClass('form-control');
                $('.dataTables_filter label').contents().filter(function() {
                    return this.nodeType === 3;
                }).remove();
                $('.dataTables_filter').addClass('float-end').css('margin-bottom', '15px');
                
                // Theme handling
                if (document.documentElement.getAttribute('data-bs-theme') === 'dark') {
                    $('.dataTables_filter input').addClass('bg-dark text-light border-secondary');
                    $('.dataTables_length select').addClass('bg-dark text-light border-secondary');
                }
            },
            columnDefs: [
                { 
                    targets: [4], // Auth Pass Rate column
                    orderable: true,
                    type: 'num',
                    render: function(data, type, row) {
                        if (type === 'sort') {
                            return parseFloat(data.match(/(\d+\.?\d*)%/)[1]);
                        }
                        return data;
                    }
                },
                { 
                    targets: [5], // Date Range column
                    orderable: true,
                    type: 'date',
                    render: function(data, type, row) {
                        if (type === 'sort') {
                            return new Date(data.split(' to ')[0]);
                        }
                        return data;
                    }
                },
                { 
                    targets: [6], // Actions column
                    orderable: false,
                    searchable: false
                }
            ]
        });
    });

</script>
{% endblock %}