{% extends "base.html" %}

{% block title %}Domains Management | DMARCus Analyzer{% endblock %}

{% block extra_css %}
<style>
    .domain-status-badge {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
    }
    .domain-status-active {
        background-color: #28a745;
    }
    .domain-status-inactive {
        background-color: #dc3545;
    }
    .domain-status-pending {
        background-color: #ffc107;
    }
    .progress-sm {
        height: 0.5rem;
    }
    .table-actions {
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row align-items-center justify-content-between mb-4">
    <div>
        <h1 class="h3 mb-0 text-gray-800">Domains Management</h1>
        <small class="text-muted">Manage your monitored domains and DMARC policies</small>
    </div>
    <div class="mt-3 mt-md-0">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDomainModal">
            <i class="bi bi-plus-circle me-1"></i> Add Domain
        </button>
    </div>
</div>

<div class="card shadow mb-4 fade-in">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">Your Domains</h6>
        <div class="input-group" style="width: 250px;">
            <input type="text" class="form-control" placeholder="Search domains..." id="domainSearch">
            <button class="btn btn-outline-secondary" type="button">
                <i class="bi bi-search"></i>
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="domainsTable">
                <thead class="table-light">
                    <tr>
                        <th>Domain</th>
                        <th>Status</th>
                        <th>DMARC Policy</th>
                        <th>Last Report</th>
                        <th>Auth Score</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for domain in domains %}
                    <tr>
                        <td>{{ domain.name }}</td>
                        <td>
                            <span class="domain-status-badge domain-status-{{ domain.status }}"></span>
                            {{ domain.status|capitalize }}
                        </td>
                        <td>
                            <span class="badge 
                                {% if domain.dmarc_policy == 'reject' %}bg-danger
                                {% elif domain.dmarc_policy == 'quarantine' %}bg-success
                                {% else %}bg-warning{% endif %}">
                                {{ domain.dmarc_policy }}
                            </span>
                        </td>
                        <td>
                            {% if domain.last_report %}
                                {{ domain.last_report }}
                            {% else %}
                                Never
                            {% endif %}
                        </td>
                        <td>
                            <div class="progress progress-sm">
                                <div class="progress-bar 
                                    {% if domain.auth_score >= 90 %}bg-success
                                    {% elif domain.auth_score >= 70 %}bg-warning
                                    {% else %}bg-danger{% endif %}" 
                                    role="progressbar" 
                                    style="width: {{ domain.auth_score }}%">
                                </div>
                            </div>
                            <small>{{ domain.auth_score }}%</small>
                        </td>
                        <td class="table-actions text-end">
                            <button class="btn btn-sm btn-outline-primary me-1 edit-domain" 
                                    title="Edit" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#editDomainModal"
                                    data-domain="{{ domain.name }}"
                                    data-dmarc="{{ domain.dmarc_policy }}"
                                    data-reporting="{{ domain.enable_reporting }}"
                                    data-emails="{{ domain.report_emails|join(', ') }}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-domain" 
                                    title="Delete" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#deleteDomainModal"
                                    data-domain="{{ domain.name }}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Domain Modal -->
<div class="modal fade" id="addDomainModal" tabindex="-1" aria-labelledby="addDomainModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addDomainModalLabel">Add New Domain</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('domains') }}">
                <input type="hidden" name="action" value="add">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="domainName" class="form-label">Domain Name</label>
                        <input type="text" class="form-control" id="domainName" name="domain_name" placeholder="example.com" required>
                    </div>
                    <div class="mb-3">
                        <label for="dmarcPolicy" class="form-label">Initial DMARC Policy</label>
                        <select class="form-select" id="dmarcPolicy" name="dmarc_policy" required>
                            <option value="none">none (monitoring only)</option>
                            <option value="quarantine">quarantine</option>
                            <option value="reject">reject</option>
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="enableReporting" name="enable_reporting" checked>
                        <label class="form-check-label" for="enableReporting">Enable reporting for this domain</label>
                    </div>
                    <div class="mb-3">
                        <label for="reportEmails" class="form-label">Report Email Addresses</label>
                        <input type="text" class="form-control" id="reportEmails" name="report_emails" placeholder="mailto:reports@example.com">
                        <div class="form-text">Separate multiple addresses with commas</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Domain</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Domain Modal -->
<div class="modal fade" id="editDomainModal" tabindex="-1" aria-labelledby="editDomainModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editDomainModalLabel">Edit Domain</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('domains') }}">
                <input type="hidden" name="action" value="update">
                <input type="hidden" name="domain_name" id="editDomainNameInput">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Domain Name</label>
                        <input type="text" class="form-control" id="editDomainName" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editDmarcPolicy" class="form-label">DMARC Policy</label>
                        <select class="form-select" id="editDmarcPolicy" name="dmarc_policy" required>
                            <option value="none">none (monitoring only)</option>
                            <option value="quarantine">quarantine</option>
                            <option value="reject">reject</option>
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editEnableReporting" name="enable_reporting">
                        <label class="form-check-label" for="editEnableReporting">Enable reporting for this domain</label>
                    </div>
                    <div class="mb-3">
                        <label for="editReportEmails" class="form-label">Report Email Addresses</label>
                        <input type="text" class="form-control" id="editReportEmails" name="report_emails">
                        <div class="form-text">Separate multiple addresses with commas</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Domain</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Domain Modal -->
<div class="modal fade" id="deleteDomainModal" tabindex="-1" aria-labelledby="deleteDomainModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteDomainModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('domains') }}" id="deleteDomainForm">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="domain_name" id="deleteDomainName">
                <div class="modal-body">
                    <p>Are you sure you want to delete the domain <strong id="domainToDelete">example.com</strong>?</p>
                    <p class="text-danger">All associated reports and data will be permanently deleted.</p>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="confirmDelete" name="confirm_delete">
                        <label class="form-check-label" for="confirmDelete">
                            I understand this action cannot be undone
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" id="confirmDeleteBtn" disabled>Delete Domain</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inizializzazione modali
        const editDomainModal = new bootstrap.Modal(document.getElementById('editDomainModal'));
        const deleteDomainModal = new bootstrap.Modal(document.getElementById('deleteDomainModal'));

        // Gestione pulsanti modifica
        document.querySelectorAll('.edit-domain').forEach(btn => {
            btn.addEventListener('click', function() {
                const domainName = this.dataset.domain;
                const dmarcPolicy = this.dataset.dmarc;
                const enableReporting = this.dataset.reporting === 'true';
                const reportEmails = this.dataset.emails;
                
                document.getElementById('editDomainNameInput').value = domainName;
                document.getElementById('editDomainName').value = domainName;
                document.getElementById('editDmarcPolicy').value = dmarcPolicy;
                document.getElementById('editEnableReporting').checked = enableReporting;
                document.getElementById('editReportEmails').value = reportEmails;
            });
        });

        // Gestione pulsanti eliminazione
        document.querySelectorAll('.delete-domain').forEach(btn => {
            btn.addEventListener('click', function() {
                const domainName = this.dataset.domain;
                document.getElementById('domainToDelete').textContent = domainName;
                document.getElementById('deleteDomainName').value = domainName;
                
                // Resetta la checkbox
                document.getElementById('confirmDelete').checked = false;
                document.getElementById('confirmDeleteBtn').disabled = true;
            });
        });

        // Abilita/disabilita pulsante di conferma eliminazione
        document.getElementById('confirmDelete').addEventListener('change', function() {
            document.getElementById('confirmDeleteBtn').disabled = !this.checked;
        });

        // Ricerca domini
        document.getElementById('domainSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#domainsTable tbody tr');
            
            rows.forEach(row => {
                const domain = row.cells[0].textContent.toLowerCase();
                row.style.display = domain.includes(searchTerm) ? '' : 'none';
            });
        });

        // Toggle tema
        document.querySelector('.theme-toggle').addEventListener('click', function() {
            const htmlEl = document.documentElement;
            const currentTheme = htmlEl.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            htmlEl.setAttribute('data-bs-theme', newTheme);
            this.innerHTML = newTheme === 'dark' ? '<i class="bi bi-sun-fill"></i>' : '<i class="bi bi-moon-fill"></i>';
            localStorage.setItem('theme', newTheme);
        });

        // Carica tema salvato
        if (localStorage.getItem('theme')) {
            document.documentElement.setAttribute('data-bs-theme', localStorage.getItem('theme'));
            const icon = document.querySelector('.theme-toggle i');
            if (icon) {
                icon.className = localStorage.getItem('theme') === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
            }
        }
    });
</script>
{% endblock %}