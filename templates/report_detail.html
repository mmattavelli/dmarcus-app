<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMARC Report - {{ report.org }} | DMARCus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        /* Stili specifici per i grafici nel tema scuro */
        [data-bs-theme="dark"] .chartjs-render-monitor {
            filter: brightness(0.85) contrast(1.2);
        }
    </style>
</head>
<body class="bg-light">
    <!-- Mobile Menu Button -->
    <button class="btn btn-primary mobile-menu-btn d-none position-fixed" style="top: 1rem; left: 1rem; z-index: 1050;">
        <i class="bi bi-list"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-brand d-flex flex-column align-items-center justify-content-center py-4 mb-2">
            <div class="">
                <img src="{{ url_for('static', filename='logo_dmarcus.png') }}" alt="DMARCus Logo" style="width: 100px; height: 100px;">
            </div>
            <div class="sidebar-brand-text mx-2 text-white">DMARCus</div>
        </div>
        <hr class="sidebar-divider my-0">
        
        <!-- Nav Items -->
        <div class="nav-item">
            <a class="nav-link" href="/dashboard">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </a>
        </div>
        
        <div class="nav-item">
            <a class="nav-link active" href="#">
                <i class="bi bi-file-earmark-text"></i>
                <span>Reports</span>
            </a>
        </div>
        
        <div class="nav-item">
            <a class="nav-link" href="/domains">
                <i class="bi bi-globe"></i>
                <span>Domains</span>
            </a>
        </div>
        
        <div class="nav-item">
            <a class="nav-link" href="/settings">
                <i class="bi bi-gear"></i>
                <span>Settings</span>
            </a>
        </div>
        
        <hr class="sidebar-divider">
        
        <div class="sidebar-heading">Tools</div>
        
        <div class="nav-item">
            <a class="nav-link" href="/analyzer">
                <i class="bi bi-search"></i>
                <span>Message Analyzer</span>
            </a>
        </div>
        
        <div class="nav-item">
            <a class="nav-link" href="/policy-generator">
                <i class="bi bi-shield-plus"></i>
                <span>Policy Generator</span>
            </a>
        </div>
        
        <hr class="sidebar-divider d-none d-md-block">
        
        <div class="text-center d-none d-md-inline">
            <button class="rounded-circle border-0" id="sidebarToggle">
                <i class="bi bi-arrow-left"></i>
            </button>
        </div>
        
        <div class="version-info">
            DMARCus v{{ version }}
        </div>
    </div>

    <!-- Topbar Compatta -->
    <nav class="navbar navbar-expand navbar-light topbar-compact">
        <div class="d-flex align-items-center ms-auto">
            <!-- Notifiche -->
            <div class="nav-item dropdown compact-notification">
                <a class="nav-link position-relative" href="#" id="alertsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-bell-fill"></i>
                    <span class="badge badge-danger badge-counter">3+</span>
                </a>
                <div class="dropdown-list dropdown-menu dropdown-menu-end shadow animated--grow-in" aria-labelledby="alertsDropdown">
                    <h6 class="dropdown-header bg-primary text-white">
                        Alerts Center
                    </h6>
                    <a class="dropdown-item d-flex align-items-center" href="#">
                        <div class="mr-3">
                            <div class="icon-circle bg-danger">
                                <i class="bi bi-exclamation-triangle text-white"></i>
                            </div>
                        </div>
                        <div>
                            <div class="small text-gray-500">December 12, 2023</div>
                            <span class="font-weight-bold">High failure rate detected for example.com</span>
                        </div>
                    </a>
                    <a class="dropdown-item d-flex align-items-center" href="#">
                        <div class="mr-3">
                            <div class="icon-circle bg-success">
                                <i class="bi bi-check-circle text-white"></i>
                            </div>
                        </div>
                        <div>
                            <div class="small text-gray-500">December 7, 2023</div>
                            Policy updated for acme.com
                        </div>
                    </a>
                    <a class="dropdown-item text-center small text-gray-500" href="#">Show All Alerts</a>
                </div>
            </div>
            
            <!-- Utente -->
            <div class="nav-item dropdown compact-user ms-2">
                <a class="nav-link" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <img class="user-avatar-sm" src="https://source.unsplash.com/QAB-WJcbgJk/60x60" alt="User profile">
                </a>
                <div class="dropdown-menu dropdown-menu-end shadow animated--grow-in" aria-labelledby="userDropdown">
                    <div class="dropdown-header">
                        <div class="d-flex align-items-center">
                            <img class="rounded-circle me-2" src="https://source.unsplash.com/QAB-WJcbgJk/60x60" width="40" height="40" alt="User">
                            <div>
                                <div class="fw-bold">Admin User</div>
                                <small class="text-muted">Administrator</small>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#">
                        <i class="bi bi-person-fill me-2 text-primary"></i>
                        Profile
                    </a>
                    <a class="dropdown-item" href="#">
                        <i class="bi bi-gear-fill me-2 text-primary"></i>
                        Settings
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#logoutModal">
                        <i class="bi bi-box-arrow-right me-2 text-primary"></i>
                        Logout
                    </a>
                </div>
            </div>
            
            <!-- Toggle Tema -->
            <div class="nav-item compact-theme ms-2">
                <a class="nav-link theme-toggle">
                    <i class="bi bi-moon-fill"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="content">
        <!-- Page Header -->
        <div class="d-flex flex-column flex-md-row align-items-center justify-content-between mb-4">
            <div>
                <div class="d-flex align-items-center">
                    <h1 class="h3 mb-0 text-gray-800">Report Analysis</h1>
                    <span class="badge bg-primary-100 text-primary-800 ms-2">{{ report.policy.p|upper }} Policy</span>
                </div>
                <div class="mt-2">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-building me-1 text-muted"></i>
                        <small class="text-muted">{{ org_name }} - {{ report.policy.domain }}</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-calendar-range me-1 text-muted"></i>
                        <small class="text-muted">{{ report.date_range.start }} to {{ report.date_range.end }}</small>
                    </div>
                </div>
                
                <!-- Report Selector -->
                <div class="mt-3">
                    <label for="reportSelector" class="form-label small text-muted text-uppercase fw-bold">Select Report</label>
                    <select id="reportSelector" class="form-select form-select-sm" style="width: 100%; max-width: 400px;">
                        <option value="all" {% if selected_report_id == 'all' %}selected{% endif %}>
                            All Reports (Aggregated)
                        </option>
                        {% for r in org_reports %}
                        <option value="{{ r.id }}" {% if selected_report_id == r.id %}selected{% endif %}>
                            {{ r.report_id }} ({{ r.date_range.start }} to {{ r.date_range.end }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="d-flex mt-3 mt-md-0">
                <div class="btn-group" role="group">
                    <a href="/dashboard" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left me-1"></i> Dashboard
                    </a>
                    <a href="/export/csv/{{ selected_report_id if selected_report_id != 'all' else org_name }}" 
                       class="btn btn-primary">
                        <i class="bi bi-download me-1"></i> Export
                    </a>
                    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#helpModal">
                        <i class="bi bi-question-circle"></i>
                    </button>
                </div>
            </div>
        </div>

<!-- Key Metrics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card kpi-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-wrapper me-3">
                                <i class="bi bi-shield-check"></i>
                            </div>
                            <div>
                                <h3 class="mb-0">{{ pass_rate }}%</h3>
                                <small class="text-muted">Authentication Score</small>
                            </div>
                        </div>
                        <div class="progress progress-sm">
                            <div class="progress-bar" role="progressbar" style="width: {{ pass_rate }}%" 
                                aria-valuenow="{{ pass_rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-wrapper me-3" style="background: rgba(40, 167, 69, 0.1); color: #28a745;">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <div>
                                <h3 class="mb-0">{{ auth_data.both_pass + auth_data.spf_pass + auth_data.dkim_pass }}</h3>
                                <small class="text-muted">Passed Checks</small>
                            </div>
                        </div>
                        <div class="progress progress-sm">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ ((auth_data.both_pass + auth_data.spf_pass + auth_data.dkim_pass) / report.records|length * 100) if report.records|length > 0 else 0 }}%" 
                                 aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-wrapper me-3" style="background: rgba(220, 53, 69, 0.1); color: #dc3545;">
                                <i class="bi bi-exclamation-triangle"></i>
                            </div>
                            <div>
                                <h3 class="mb-0">{{ auth_data.fail + auth_data.alignment_fail }}</h3>
                                <small class="text-muted">Failed Checks</small>
                            </div>
                        </div>
                        <div class="progress progress-sm">
                            <div class="progress-bar bg-danger" role="progressbar" 
                                 style="width: {{ ((auth_data.fail + auth_data.alignment_fail) / report.records|length * 100) if report.records|length > 0 else 0 }}%" 
                                 aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-wrapper me-3" style="background: rgba(108, 117, 125, 0.1); color: #6c757d;">
                                <i class="bi bi-envelope"></i>
                            </div>
                            <div>
                                <h3 class="mb-0">{{ report.records|length }}</h3>
                                <small class="text-muted">Total Messages</small>
                            </div>
                        </div>
                        <div class="progress progress-sm">
                            <div class="progress-bar bg-secondary" role="progressbar" style="width: 100%" 
                                aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column - Summary Cards -->
            <div class="col-lg-4">
                <!-- Report Metadata -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="bi bi-info-circle me-2"></i>Report Metadata
                        </h6>
                        <span class="badge bg-primary">{{ report.report_id|truncate(10) }}</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted text-uppercase fw-bold">Organization</small>
                            <p class="mb-0">{{ report.org }}</p>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted text-uppercase fw-bold">Report ID</small>
                            <p class="mb-0">{{ report.report_id }}</p>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted text-uppercase fw-bold">Date Range</small>
                            <p class="mb-0">{{ report.date_range.start }} to {{ report.date_range.end }}</p>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted text-uppercase fw-bold">Total Records</small>
                            <p class="mb-0">{{ report.records|length }} messages</p>
                        </div>
                    </div>
                </div>

                <!-- Policy Settings -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="bi bi-shield-lock me-2"></i>Policy Settings
                        </h6>
                        <span class="badge bg-{% if report.policy.p == 'none' %}warning{% elif report.policy.p == 'quarantine' %}info{% else %}danger{% endif %}">
                            {{ report.policy.p|upper }}
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted text-uppercase fw-bold">Domain</small>
                            <p class="mb-0">{{ report.policy.domain }}</p>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted text-uppercase fw-bold">Policy</small>
                            <p class="mb-0">{{ report.policy.p|upper }} (applied to {{ report.policy.pct }}% of messages)</p>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted text-uppercase fw-bold">Subdomain Policy</small>
                            <p class="mb-0">{{ report.policy.sp|upper if report.policy.sp != 'N/A' else 'Same as domain' }}</p>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted text-uppercase fw-bold">Alignment Mode</small>
                            <p class="mb-0">
                                <span class="badge bg-info">DKIM: {{ report.policy.adkim|upper }}</span>
                                <span class="badge bg-info ms-1">SPF: {{ report.policy.aspf|upper }}</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Main Report Content -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="reportTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="true">
                                    <i class="bi bi-bar-chart me-1"></i> Summary
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="records-tab" data-bs-toggle="tab" data-bs-target="#records" type="button" role="tab" aria-controls="records" aria-selected="false">
                                    <i class="bi bi-table me-1"></i> Records
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="ips-tab" data-bs-toggle="tab" data-bs-target="#ips" type="button" role="tab" aria-controls="ips" aria-selected="false">
                                    <i class="bi bi-globe me-1"></i> IP Analysis
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="reportTabsContent">
                            <!-- Summary Tab -->
                            <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <div class="card h-100">
                                            <div class="card-header bg-white">
                                                <h6 class="m-0 font-weight-bold text-primary">Authentication Results</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="chart-container">
                                                    <canvas id="authChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">
                                        <div class="card h-100">
                                            <div class="card-header bg-white">
                                                <h6 class="m-0 font-weight-bold text-primary">Disposition Analysis</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="chart-container">
                                                    <canvas id="dispositionChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">
                                        <div class="card h-100">
                                            <div class="card-header bg-white">
                                                <h6 class="m-0 font-weight-bold text-primary">Internal vs External</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="chart-container">
                                                    <canvas id="internalChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">
                                        <div class="card h-100">
                                            <div class="card-header bg-white">
                                                <h6 class="m-0 font-weight-bold text-primary">Top Sending IPs</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="chart-container">
                                                    <canvas id="ipChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Records Tab -->
                            <div class="tab-pane fade" id="records" role="tabpanel" aria-labelledby="records-tab">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="d-flex align-items-center">
                                        <input type="text" id="recordSearch" class="form-control form-control-sm" placeholder="Search records..." style="width: 250px;">
                                    </div>
                                    <div>
                                        <small class="text-muted me-2">{{ report.records|length }} records</small>
                                        <button class="btn btn-sm btn-outline-secondary" id="toggleFailedOnly">
                                            <i class="bi bi-filter-circle"></i> Show Failed Only
                                        </button>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover" id="recordsTable">
                                        <thead>
                                            <tr>
                                                <th>Source IP</th>
                                                <th>Count</th>
                                                <th>SPF</th>
                                                <th>DKIM</th>
                                                <th>Alignment</th>
                                                <th>Disposition</th>
                                                <th>Header From</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for record in report.records %}
                                            <tr class="{% if record.spf != 'pass' or record.dkim != 'pass' %}table-warning{% endif %}">
                                                <td>
                                                    <span class="d-block">{{ record.source_ip }}</span>
                                                    {% if record.is_internal %}
                                                        <span class="badge badge-info">Internal</span>
                                                    {% endif %}
                                                    <small class="text-muted d-block">{{ record.location }}</small>
                                                </td>
                                                <td>{{ record.count }}</td>
                                                <td>
                                                    <span class="badge {% if record.spf == 'pass' %}badge-success{% else %}badge-danger{% endif %}">
                                                        {{ record.spf }}
                                                    </span>
                                                    {% if record.spf_domain %}
                                                        <small class="text-muted d-block">{{ record.spf_domain }}</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge {% if record.dkim == 'pass' %}badge-success{% else %}badge-danger{% endif %}">
                                                        {{ record.dkim }}
                                                    </span>
                                                    {% if record.dkim_domain %}
                                                        <small class="text-muted d-block">{{ record.dkim_domain }}</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% set spf_aligned = record.spf_domain.endswith(report.policy.domain) %}
                                                    {% set dkim_aligned = record.dkim_domain.endswith(report.policy.domain) %}
                                                    
                                                    {% if record.spf == 'pass' or record.dkim == 'pass' %}
                                                        {% if spf_aligned and dkim_aligned %}
                                                            <span class="badge bg-success">Aligned</span>
                                                        {% elif spf_aligned or dkim_aligned %}
                                                            <span class="badge bg-warning">Partial</span>
                                                        {% else %}
                                                            <span class="badge bg-danger">Failed</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="badge bg-secondary">N/A</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-{% if record.disposition == 'pass' %}success{% elif record.disposition == 'quarantine' %}warning{% else %}danger{% endif %}">
                                                        {{ record.disposition }}
                                                    </span>
                                                </td>
                                                <td>{{ record.header_from }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- IP Analysis Tab -->
                            <div class="tab-pane fade" id="ips" role="tabpanel" aria-labelledby="ips-tab">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="d-flex align-items-center">
                                        <input type="text" id="ipSearch" class="form-control form-control-sm" placeholder="Search IPs..." style="width: 250px;">
                                    </div>
                                    <div>
                                        <small class="text-muted">{{ ip_addresses|length }} unique IPs</small>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover" id="ipTable">
                                        <thead>
                                            <tr>
                                                <th>IP Address</th>
                                                <th>Count</th>
                                                <th>Location</th>
                                                <th>Authentication</th>
                                                <th>Disposition</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for ip, count in ip_addresses.items()|sort(attribute='1', reverse=True) %}
                                            {% set ip_records = report.records|selectattr('source_ip', 'equalto', ip)|list %}
                                            {% set spf_pass = ip_records|selectattr('spf', 'equalto', 'pass')|list|length %}
                                            {% set dkim_pass = ip_records|selectattr('dkim', 'equalto', 'pass')|list|length %}
                                            {% set pass_rate = ((spf_pass + dkim_pass) / (ip_records|length * 2) * 100) if ip_records|length > 0 else 0 %}
                                            <tr>
                                                <td>
                                                    <span class="d-block">{{ ip }}</span>
                                                    {% if ip_records[0].is_internal %}
                                                        <span class="badge bg-info">Internal</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ count }}</td>
                                                <td>{{ ip_records[0].location }}</td>
                                                <td>
                                                    <div class="progress progress-sm">
                                                        <div class="progress-bar" role="progressbar" 
                                                             style="width: {{ pass_rate }}%" 
                                                             aria-valuenow="{{ pass_rate }}" 
                                                             aria-valuemin="0" 
                                                             aria-valuemax="100"></div>
                                                    </div>
                                                    <small>{{ pass_rate|round(1) }}% passed</small>
                                                </td>
                                                <td>
                                                    {% set dispositions = ip_records|groupby('disposition') %}
                                                    {% for disp, records in dispositions %}
                                                        <span class="badge bg-{% if disp == 'pass' %}success{% elif disp == 'quarantine' %}warning{% else %}danger{% endif %}">
                                                            {{ disp }}: {{ records|length }}
                                                        </span>
                                                    {% endfor %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">DMARC Report Help</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="accordion" id="helpAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    Understanding DMARC Reports
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>DMARC (Domain-based Message Authentication, Reporting & Conformance) reports provide visibility into who is sending email on behalf of your domain and whether those emails are passing authentication checks.</p>
                                    <p>Key components of a DMARC report:</p>
                                    <ul>
                                        <li><strong>SPF (Sender Policy Framework):</strong> Verifies the sender's IP address is authorized to send email for the domain.</li>
                                        <li><strong>DKIM (DomainKeys Identified Mail):</strong> Uses cryptographic signatures to verify the email wasn't altered in transit.</li>
                                        <li><strong>Alignment:</strong> Checks if the domains used in SPF and DKIM match the domain in the From header.</li>
                                        <li><strong>Disposition:</strong> Shows what action was taken (none, quarantine, reject) based on your DMARC policy.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTwo">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    Interpreting the Data
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>This report details email authentication results for your domain over a specific time period.</p>
                                    <p><strong>Key metrics to monitor:</strong></p>
                                    <ul>
                                        <li><strong>Authentication Score:</strong> Percentage of emails passing both SPF and DKIM checks with proper alignment.</li>
                                        <li><strong>Failed Checks:</strong> Emails failing authentication that may be spoofed or malicious.</li>
                                        <li><strong>IP Analysis:</strong> Identifies which IP addresses are sending email for your domain and their authentication success rates.</li>
                                    </ul>
                                    <p>Regularly review these reports to identify unauthorized senders and adjust your email authentication policies accordingly.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Modal -->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                    <button class="close text-white" type="button" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">Ã—</span>
                    </button>
                </div>
                <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
                    <a class="btn btn-primary" href="login.html">Logout</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Theme toggle - Stessa implementazione di upload.html
        document.querySelector('.theme-toggle').addEventListener('click', function() {
            const htmlEl = document.documentElement;
            const currentTheme = htmlEl.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            htmlEl.setAttribute('data-bs-theme', newTheme);
            this.innerHTML = newTheme === 'dark' ? '<i class="bi bi-sun-fill"></i>' : '<i class="bi bi-moon-fill"></i>';
            
            localStorage.setItem('theme', newTheme);
            updateChartColors(newTheme);
        });
        
        // Verifica la preferenza del tema al caricamento
        if (localStorage.getItem('theme')) {
            const savedTheme = localStorage.getItem('theme');
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            document.querySelector('.theme-toggle i').className = savedTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
        }

        // Inizializzazione grafici con colori dinamici
        function getChartColors(theme) {
            return theme === 'dark' ? {
                textColor: '#ffffff',
                gridColor: 'rgba(255, 255, 255, 0.1)',
                backgroundColors: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(23, 162, 184, 0.8)',
                    'rgba(111, 66, 193, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ],
                hoverColors: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(23, 162, 184, 1)',
                    'rgba(111, 66, 193, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(220, 53, 69, 1)'
                ]
            } : {
                textColor: '#666',
                gridColor: 'rgba(0, 0, 0, 0.1)',
                backgroundColors: [
                    '#28a745',
                    '#17a2b8',
                    '#6f42c1',
                    '#ffc107',
                    '#dc3545'
                ],
                hoverColors: [
                    '#5cdb95',
                    '#5bc0de',
                    '#9d65c9',
                    '#ffd166',
                    '#ff6b6b'
                ]
            };
        }

        // Funzione per aggiornare i colori dei grafici in base al tema
        function updateChartColors(theme) {
            if (theme === 'dark') {
                Chart.defaults.color = '#ffffff';
                Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
            } else {
                Chart.defaults.color = '#666';
                Chart.defaults.borderColor = 'rgba(0, 0, 0, 0.1)';
            }

            // Ridisponi i grafici esistenti
            if (window.authChart) window.authChart.update();
            if (window.dispositionChart) window.dispositionChart.update();
            if (window.internalChart) window.internalChart.update();
            if (window.ipChart) window.ipChart.update();
        }

        // Mobile menu toggle
        document.querySelector('.mobile-menu-btn').addEventListener('click', function() {
            document.querySelector('.sidebar').classList.toggle('active');
        });

        // Toggle Sidebar
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.body.classList.toggle('sidebar-toggled');
            document.querySelector('.sidebar').classList.toggle('toggled');
            
            if (document.querySelector('.sidebar').classList.contains('toggled')) {
                document.querySelector('.sidebar .collapse').classList.remove('show');
            }
        });

        // Chiudi il menu mobile quando si clicca su un link
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth < 992) {
                    document.querySelector('.sidebar').classList.remove('active');
                }
            });
        });

        // Report selector
        document.getElementById('reportSelector').addEventListener('change', function() {
            const reportId = this.value;
            const orgName = '{{ org_name }}';
            
            if (reportId === 'all') {
                window.location.href = `/report/${orgName}`;
            } else {
                window.location.href = `/report/${orgName}/${reportId}`;
            }
        });
        // Record search functionality
        document.getElementById('recordSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#recordsTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // IP search functionality
        document.getElementById('ipSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#ipTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Toggle failed only records
        document.getElementById('toggleFailedOnly').addEventListener('click', function() {
            const showFailedOnly = this.classList.toggle('active');
            const rows = document.querySelectorAll('#recordsTable tbody tr');
            
            if (showFailedOnly) {
                this.innerHTML = '<i class="bi bi-filter-circle-fill"></i> Show All';
                rows.forEach(row => {
                    if (!row.classList.contains('table-warning')) {
                        row.style.display = 'none';
                    }
                });
            } else {
                this.innerHTML = '<i class="bi bi-filter-circle"></i> Show Failed Only';
                rows.forEach(row => {
                    row.style.display = '';
                });
            }
        });

        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Authentication Results Chart
        const authCtx = document.getElementById('authChart').getContext('2d');
        const currentTheme = document.documentElement.getAttribute('data-bs-theme') || 'light';
        const colors = getChartColors(currentTheme);

        window.authChart = new Chart(authCtx, {
            type: 'doughnut',
            data: {
                labels: ['Both Pass', 'SPF Only', 'DKIM Only', 'Alignment Fail', 'Failures'],
                datasets: [{
                    data: [
                        {{ auth_data.both_pass }},
                        {{ auth_data.spf_pass }},
                        {{ auth_data.dkim_pass }},
                        {{ auth_data.alignment_fail }},
                        {{ auth_data.fail }}
                    ],
                    backgroundColor: colors.backgroundColors,
                    hoverBackgroundColor: colors.hoverColors,
                    borderWidth: 0
                }]
            },
            options: {
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: colors.textColor,
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                family: 'Poppins',
                                size: 13
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: currentTheme === 'dark' ? 'rgba(0, 0, 0, 0.9)' : 'rgba(0, 0, 0, 0.8)',
                        bodyColor: "#fff",
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const value = context.raw;
                                const percentage = Math.round((value / total) * 100);
                                return ` ${context.label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Disposition Analysis Chart
        const dispositionCtx = document.getElementById('dispositionChart').getContext('2d');
        new Chart(dispositionCtx, {
            type: 'pie',
            data: {
                labels: {{ dispositions.keys()|list|tojson }},
                datasets: [{
                    data: {{ dispositions.values()|list|tojson }},
                    backgroundColor: [
                        '#006ec5', '#36a6f6', '#7cc4fa', '#b9dffd', '#e0effe'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        bodyColor: "#fff",
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        caretPadding: 10,
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const value = context.raw;
                                const percentage = Math.round((value / total) * 100);
                                return ` ${context.label}: ${value} (${percentage}%)`;
                            }
                        },
                        bodyFont: {
                            family: 'Poppins',
                            size: 13
                        }
                    },
                    legend: {
                        position: 'right',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                family: 'Poppins',
                                size: 13
                            }
                        }
                    }
                }
            }
        });

        // Internal vs External Chart
        const internalCtx = document.getElementById('internalChart').getContext('2d');
        new Chart(internalCtx, {
            type: 'pie',
            data: {
                labels: ['Internal IPs', 'External IPs'],
                datasets: [{
                    data: [
                        {{ internal_vs_external.internal }},
                        {{ internal_vs_external.external }}
                    ],
                    backgroundColor: [
                        '#006ec5', '#36a6f6'
                    ],
                    hoverBackgroundColor: [
                        '#0157a0', '#0c8ce7'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        bodyColor: "#fff",
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        caretPadding: 10,
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const value = context.raw;
                                const percentage = Math.round((value / total) * 100);
                                return ` ${context.label}: ${value} (${percentage}%)`;
                            }
                        },
                        bodyFont: {
                            family: 'Poppins',
                            size: 13
                        }
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                family: 'Poppins',
                                size: 13
                            }
                        }
                    }
                }
            }
        });

        // Top Sending IPs Chart
        const ipCtx = document.getElementById('ipChart').getContext('2d');
        new Chart(ipCtx, {
            type: 'bar',
            data: {
                labels: {{ ip_chart_data.ips|tojson }},
                datasets: [{
                    label: 'Email Count',
                    data: {{ ip_chart_data.counts|tojson }},
                    backgroundColor: [
                        '#006ec5', '#36a6f6', '#7cc4fa', '#b9dffd', '#e0effe'
                    ],
                    borderWidth: 0,
                    borderRadius: 4,
                    hoverBackgroundColor: [
                        '#0157a0', '#0c8ce7', '#36a6f6', '#7cc4fa', '#b9dffd'
                    ]
                }]
            },
            options: {
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        bodyColor: "#fff",
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return ` ${context.parsed.x} emails`;
                            }
                        },
                        bodyFont: {
                            family: 'Poppins',
                            size: 13
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            precision: 0,
                            font: {
                                family: 'Poppins'
                            }
                        }
                    },
                    y: {
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                family: 'Poppins'
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>